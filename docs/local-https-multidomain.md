# Local HTTPS Multi-Domain Development

This guide explains how to run PhotoCloud locally with HTTPS and tenant subdomains, matching the production architecture.

## Overview

The local setup uses:
- **Traefik** reverse proxy (Docker) for HTTPS routing
- **mkcert** for trusted local TLS certificates
- **lvh.me** wildcard domain (resolves to `127.0.0.1`)
- **No exposed ports** except `80` and `443`

## Prerequisites

- Docker Desktop
- mkcert installed and configured

### Install mkcert (macOS)

```bash
brew install mkcert nss
mkcert -install
```

**Important**: `mkcert -install` is a **one-time setup** that:
- Creates a local Certificate Authority (CA)
- Adds the CA to your macOS system Keychain
- Makes **all browsers automatically trust** any certificates generated by mkcert

You do **not** need to manually import certificates into your browser. Once the CA is installed, all mkcert-generated certificates (including wildcard certificates like `*.lvh.me`) will be automatically trusted.

## Setup Steps

### 1. Generate Local TLS Certificates

From the repository root:

```bash
mkdir -p local-certs
mkcert -cert-file ./local-certs/lvh.me.pem -key-file ./local-certs/lvh.me-key.pem "*.lvh.me" lvh.me
```

This creates:
- `local-certs/lvh.me.pem` - Certificate file
- `local-certs/lvh.me-key.pem` - Private key file

**Note**: `local-certs/` is intentionally local-only. To ignore it in git, add to `.git/info/exclude` or your global gitignore.

### 2. Start the Reverse Proxy

Set your deployed dev API Gateway URL:

```bash
export DEV_API_ORIGIN="https://YOUR_DEV_EXECUTE_API_ID.execute-api.eu-west-1.amazonaws.com"
docker compose -f docker/local/compose.yml up
```

The proxy will:
- Listen on `:80` (redirects to HTTPS) and `:443`
- Route `dashboard.lvh.me` → dashboard dev server (port 3000)
- Route `photocloud.lvh.me` → landing dev server (port 3002)
- Route `*.lvh.me` (tenant subdomains) → gallery dev server (port 3001)
- Route `/api/*` from any host → dev API Gateway (with prefix stripped)
- Route `api.lvh.me` → dev API Gateway (direct)

### 3. Configure Cognito App Client

**⚠️ IMPORTANT**: You must add the new callback URLs and sign-out URLs to your Cognito App Client settings:

1. Go to **AWS Console → Cognito → User Pools → Your User Pool → App integration → App clients**
2. Select your app client
3. Under **Hosted UI**, add these **callback URLs**:
   - `https://dashboard.lvh.me/auth/auth-callback`
   - `https://photocloud.lvh.me/auth/auth-callback` (if landing page has auth)
   - `https://dashboard.lvh.me` (needed for logout redirect_uri)
   - `https://photocloud.lvh.me` (needed for logout redirect_uri)
4. Add these **sign-out URLs** (required for logout):
   - `https://dashboard.lvh.me`
   - `https://photocloud.lvh.me`
   - **Important**: Do NOT include trailing slashes in sign-out URLs
5. Save changes

**Note**: 
- The redirect URI is dynamically constructed using `window.location.origin`, so it will automatically use the correct domain
- For logout, the code uses both `logout_uri` and `redirect_uri` parameters
  - `logout_uri` must match an allowed sign-out URL exactly (no trailing slash)
  - `redirect_uri` must match an allowed callback URL
- Make sure both the root URLs are in both lists (callback URLs and sign-out URLs)

### 4. Run Next.js Dev Servers

In separate terminals, run each app on its default port:

**Terminal 1 - Dashboard:**
```bash
cd frontend/dashboard
yarn dev
# Runs on http://0.0.0.0:3000
```

**Terminal 2 - Gallery:**
```bash
cd frontend/gallery
yarn dev
# Runs on http://0.0.0.0:3001
```

**Terminal 3 - Landing:**
```bash
cd frontend/landing
yarn dev
# Runs on http://0.0.0.0:3002
```

**Important**: The dev servers must bind to `0.0.0.0` (not `localhost`) to be reachable from Docker. Next.js dev server does this by default, but if you see 502 errors, ensure your dev server is accessible from Docker.

### 5. Access the Apps

Once everything is running:

- **Dashboard**: https://dashboard.lvh.me
- **Landing**: https://photocloud.lvh.me
- **Gallery (tenant)**: https://michalphotography.lvh.me/<galleryId>
- **API (direct)**: https://api.lvh.me/health
- **API (same-origin)**: https://dashboard.lvh.me/api/health

## Tenant Subdomains

During signup, users can optionally choose a subdomain (e.g., `michalphotography`). After email confirmation, the subdomain is reserved and galleries are accessible at:

```
https://<subdomain>.lvh.me/<galleryId>
```

Example:
- User signs up with subdomain `michalphotography`
- After confirmation, gallery `abc123` is accessible at:
  - `https://michalphotography.lvh.me/abc123`

## Stripe Configuration

**No changes needed** for Stripe when using the local proxy setup:

- Stripe checkout success URLs use the backend API Gateway URL (`${apiUrl}/payments/success`), which is independent of the frontend domain
- Frontend redirect URLs after payment are set dynamically using `window.location.origin`, so they automatically work with the proxy
- Stripe webhooks use EventBridge (not direct webhook URLs), so no webhook URL configuration is needed

## Troubleshooting

### Certificate Not Trusted

If you see certificate warnings or "Not Secure" in your browser:

1. **Verify mkcert CA is installed** (should show a path, not an error):
   ```bash
   mkcert -CAROOT
   ```

2. **Check if CA is in system Keychain** (macOS):
   ```bash
   security find-certificate -c "mkcert" -a /Library/Keychains/System.keychain
   ```

3. **If not found, reinstall the CA**:
   ```bash
   mkcert -install
   ```

4. **Restart your browser** - browsers cache certificate trust decisions.

**Note**: You should **not** need to manually import certificates into your browser. The `mkcert -install` command handles browser trust automatically.

### 502 Bad Gateway from Proxy

The proxy can't reach the Next.js dev servers. Check:

1. **Dev server binding**: Ensure Next.js binds to `0.0.0.0` (default). If using a custom host, update `docker/local/compose.yml` to match.

2. **Port conflicts**: Verify ports 3000, 3001, 3002 are not in use:
   ```bash
   lsof -i :3000
   lsof -i :3001
   lsof -i :3002
   ```

3. **Docker network**: Ensure Docker Desktop is running and the proxy container can reach `host.docker.internal`.

### API Calls Fail

If API calls return errors:

1. **Check `DEV_API_ORIGIN`**: Ensure it's set to your deployed dev API Gateway URL:
   ```bash
   echo $DEV_API_ORIGIN
   ```

2. **Verify API Gateway**: Test the API directly:
   ```bash
   curl https://YOUR_DEV_EXECUTE_API_ID.execute-api.eu-west-1.amazonaws.com/health
   ```

3. **Check proxy logs**: View Traefik logs:
   ```bash
   docker compose -f docker/local/compose.yml logs -f traefik
   ```

### Subdomain Not Working

If tenant subdomains don't resolve:

1. **DNS**: `*.lvh.me` should resolve to `127.0.0.1` automatically. Test:
   ```bash
   ping dashboard.lvh.me
   # Should resolve to 127.0.0.1
   ```

2. **Browser cache**: Clear DNS cache or use a private window.

3. **Proxy routing**: Check Traefik logs for routing decisions.

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Browser                              │
│  https://dashboard.lvh.me                              │
│  https://photocloud.lvh.me                             │
│  https://<tenant>.lvh.me/<galleryId>                   │
└──────────────────┬──────────────────────────────────────┘
                   │
                   │ HTTPS (port 443)
                   │
┌──────────────────▼──────────────────────────────────────┐
│              Traefik (Docker)                           │
│  - TLS termination (mkcert certs)                      │
│  - Host-based routing                                   │
│  - Path prefix stripping (/api/*)                       │
└──┬──────────────┬──────────────┬────────────────────────┘
   │              │              │
   │ :3000        │ :3001        │ :3002
   │              │              │
┌──▼──┐      ┌───▼───┐      ┌───▼───┐
│Dash │      │Gallery│      │Landing│
│Next │      │ Next  │      │ Next  │
└─────┘      └───────┘      └───────┘
```

## Environment Variables

For local development with the Traefik proxy, you **must** set the following environment variables in each app's `.env.local` file:

**Dashboard** (`frontend/dashboard/.env.local`):
```bash
NEXT_PUBLIC_API_URL=https://your-api-gateway-url
NEXT_PUBLIC_DASHBOARD_URL=https://dashboard.lvh.me
NEXT_PUBLIC_GALLERY_URL=https://gallery.lvh.me
NEXT_PUBLIC_LANDING_URL=https://photocloud.lvh.me
```

**Gallery** (`frontend/gallery/.env.local`):
```bash
NEXT_PUBLIC_API_URL=https://your-api-gateway-url
NEXT_PUBLIC_DASHBOARD_URL=https://dashboard.lvh.me
NEXT_PUBLIC_LANDING_URL=https://photocloud.lvh.me
```

**Landing** (`frontend/landing/.env.local`):
```bash
NEXT_PUBLIC_DASHBOARD_URL=https://dashboard.lvh.me
NEXT_PUBLIC_LANDING_URL=https://photocloud.lvh.me
```

These are required for:
- Cross-app redirects (e.g., from landing to dashboard)
- Gallery preview links
- Authentication flows
- API URL construction (when not using same-origin `/api`)

**Note**: The apps use `window.location.origin` for same-origin redirects, which automatically works with the proxy. The environment variables are primarily for cross-domain navigation.

### Infrastructure Environment Variables

If you're deploying the backend infrastructure (or redeploying), update `infra/.env` (or `infra/env.example` → `.env`) with the local development URLs:

```bash
PUBLIC_GALLERY_URL=https://gallery.lvh.me
PUBLIC_LANDING_URL=https://photocloud.lvh.me
PUBLIC_DASHBOARD_URL=https://dashboard.lvh.me
PUBLIC_API_URL=https://your-api-gateway-url
```

These URLs are written to AWS SSM Parameter Store during deployment and are used by backend Lambda functions for:
- Email links (gallery links sent to clients)
- Stripe payment success redirects
- Various redirects and links in the system

**Important**: If your backend is already deployed and you don't want to redeploy, the backend will continue using the existing SSM parameter values. You only need to update these if you want emails/links from the backend to point to your local development URLs.

For production deployments, use your production domain URLs instead of `*.lvh.me`.

## Next Steps

- See [Authentication Architecture](authentication-architecture.md) for cross-domain auth details
- See [User Flows](user-flows.md) for gallery creation and client workflows
- See [Architecture Overview](arch.md) for system design
